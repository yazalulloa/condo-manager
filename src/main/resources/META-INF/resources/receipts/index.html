<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Recibos</title>
  <link href="/out/css/output.css" rel="stylesheet"/>
  <script src="/out/js/index.js" defer></script>
</head>
<body>

<div class="bg-base-100 flex flex-col gap-1 p-1 fade-me-in fade-me-out" id="header-container" hx-swap-oob="true">
  <div id="progress-receipts" class="text-center">
  </div>
  <div class="header">
    <div id="receipts-counters"></div>
    <label>
      <div id="buildings-selector"></div>
    </label>

    <div id="receipts-updater"
         hidden="hidden"
         hx-get="/api/receipts"
         hx-include="[name='building_input'],[name='month_input'],[name='date_input']"
         hx-trigger="update_receipts delay:300ms"
         hx-target="#receipt-grid"
         hx-swap="innerHTML"
         hx-indicator=".htmx-indicator"
    >

    </div>

    <input class="datepicker"
           type="date"
           name="date_input"
           placeholder="YYYY-MM-DD"
           script="on change send 'update_receipts' to #receipts-updater">

    <div>

      <select name="month_input"
              script="on change send 'update_receipts' to #receipts-updater"
              data-te-select-init
              multiple>

        <option value="1">Enero</option>
        <option value="2">Febrero</option>
        <option value="3">Marzo</option>
        <option value="4">Abril</option>
        <option value="5">Mayo</option>
        <option value="6">Junio</option>
        <option value="7">Julio</option>
        <option value="8">Agosto</option>
        <option value="9">Septiembre</option>
        <option value="10">Octubre</option>
        <option value="11">Noviembre</option>
        <option value="12">Diciembre</option>
      </select>
      <label data-te-select-label-ref>Mes</label>
    </div>

    <input id="file-input" hidden="hidden"/>

    <img class="htmx-indicator white-filter" src="/assets/bars.svg" alt="spinner">
  </div>
</div>

<div id="container" hx-swap-oob="true" class="p-2 gap-1 flex flex-col"
     x-data="{
     zip_dialog_open: false, zip_dialog_receipt_key: '', zip_dialog_building: '', zip_dialog_date: '', zip_dialog_year: 0, zip_dialog_month: '',
     send_dialog_open: false, send_dialog_receipt_key: '', send_dialog_building: '', send_dialog_date: '', send_dialog_year: 0, send_dialog_month: '',
     send_dialog_receipt_select_all : true, send_dialog_apts: []}">

  <div id="dialog-helper"></div>

  <dialog id="receipt-send-dialog"
          class="z-30 form-container rounded border-2 border-gray-400 bg-base-100 m-0 top-1/2 left-1/2 p-2 max-h-95per"
          @event-receipt-send-dialog.window="
          $dispatch('event-set-receipt-send-dialog-apt-' + send_dialog_building.toLowerCase());
          document.getElementById('dialog-error').innerHTML = '';
          send_dialog_open = true;
          "
          x-effect="
           if (send_dialog_open) {
            send_dialog_receipt_select_all = true;
            $el.show();
          } else {
            $el.close();
          }"
  >
    <div class="p-2 h-full">

      <form class="items-center text-center overflow-hidden h-full"
            hx-post="/api/receipts/send_receipt"
            hx-disabled-elt="this, button"
            hx-swap="none"
            hx-indicator=".htmx-indicator">

        <input type="hidden" type="text" name="key" x-bind:value="send_dialog_receipt_key">

        <div id="send-receipt-dialog-csrf" hidden="hidden"></div>

        <div class="flex flex-row justify-between">
          <div style="height: 3rem; width: 3rem;">

          </div>
          <h2 class="font-bold m-auto">ENVIAR RECIBO</h2>
          <div>
            <button type="button" class="btn btn-square btn-outline btn-error" style="height: 3rem; width: 3rem;"
                    @click="send_dialog_open = false"
            >
              <img src="/assets/cross-svgrepo-com.svg" alt="remove-email" style="height: 1.5rem; width: 1.5rem">
            </button>
          </div>
        </div>

        <div class="flex flex-col gap-2 font-bold pb-2">
          <div>
            <span x-text="send_dialog_building"></span>
          </div>

          <div class="flex flex-row gap-2 justify-center">
            <span x-text="send_dialog_year"></span>
            <span x-text="send_dialog_month"></span>
            <span x-text="send_dialog_date"></span>
          </div>
        </div>

        <cm-form-input
            class=""
            name="subject"
            maxlength="100"
            placeholder="Sujeto"
            value="AVISO DE COBRO"
        >

        </cm-form-input>

        <label class="form-control">
          <div class="label">
            <span class="label-text">Mensaje</span>
          </div>
          <textarea class="textarea textarea-bordered" name="msg" autocomplete="on">AVISO DE COBRO</textarea>
        </label>

        <div id="send-dialog-error" hidden="hidden">
        </div>


        <label class="label justify-center gap-4 cursor-pointer">
          <span class="label-text">Seleccionar todos</span>
          <input type="checkbox" class="toggle"
                 @click="send_dialog_receipt_select_all=!send_dialog_receipt_select_all"
                 x-bind:checked="send_dialog_receipt_select_all"/>
        </label>

        <div class="pb-2">
          <template x-for="apt in send_dialog_apts">
            <div class="grid apt-receipt-dialog-grid gap-2">
              <div x-text="apt.number"></div>
              <div x-text="apt.name"></div>
              <div>
                <input type="checkbox" checked="checked" class="receipt-sent-checkbox checkbox" name="apts"
                       x-effect="$el.checked = send_dialog_receipt_select_all"
                       x-bind:value="apt.number"/>
              </div>
            </div>
          </template>

        </div>

        <div id="dialog-error" hidden="hidden">
        </div>

        <div class="flex flex-row gap-4">
          <button type="submit" class="btn btn-primary">
            Enviar
          </button>
          <button type="button" class="btn btn-secondary"
                  @click="send_dialog_open = false">
            Cancelar
          </button>
          <img class="htmx-indicator white-filter" src="/assets/bars.svg" alt="spinner">
        </div>

      </form>
    </div>
  </dialog>

  <div id="receipt-grid">
    <div hx-get="/api/receipts/init" hx-indicator=".htmx-indicator" hx-trigger="load" hx-swap="outerHTML"></div>
  </div>

  <div>
    <img class="htmx-indicator center img-medium-size white-filter" src="/assets/bars.svg" alt="spinner">
  </div>

  <dialog id="dialog-cm" hidden="hidden">

  </dialog>

  <dialog
      class="z-30 form-container rounded border-2 border-gray-400 bg-base-100 m-0 top-1/2 left-1/2 p-2 max-h-95per min-w-1/2"
      x-data="{email_input: '', disable_btn: false, emails: new Set(), zip_msg: ''}"
      x-effect="
          zip_msg = '';
          email_input = '';
          emails.clear();
           if (zip_dialog_open) {
            $el.show();
          } else {
            $el.close();
          }"
      @add-receipt-zip-dialog-email="
          let v = $event.detail?.email?.trim();
          if (v && v.length > 0 && validateEmail(v)) {
            emails.add(v);
          }
          "
  >

    <form id="send-zip-form"
          hx-post="/api/receipts/send_zip"
          hx-disabled-elt="this, button"
          hx-swap="none"
          hx-indicator=".htmx-indicator">

      <script>
        document.currentScript.parentElement.addEventListener("keypress", (event) => {
          event.key === "Enter" && event.preventDefault();
        });

      </script>

      <div id="receipt-dialog-content-zip" class="p-2 h-full text-center align-middle flex flex-col gap-4">

        <input type="hidden" type="text" name="key" x-bind:value="zip_dialog_receipt_key">

        <div id="csrf-input" hidden="hidden"></div>

        <div class="flex flex-row justify-between">
          <div style="height: 3rem; width: 3rem;">

          </div>
          <h2 class="font-bold m-auto">ENVIAR ZIP</h2>
          <div>
            <button type="button" class="btn btn-square btn-outline btn-error" style="height: 3rem; width: 3rem;"
                    @click="zip_dialog_open = false"
            >
              <img src="/assets/cross-svgrepo-com.svg" alt="remove-email" style="height: 1.5rem; width: 1.5rem">
            </button>
          </div>
        </div>

        <div class="flex flex-col gap-2 font-bold pb-2">
          <div>
            <span x-text="zip_dialog_building"></span>
          </div>

          <div class="flex flex-row gap-2 justify-center">
            <span x-text="zip_dialog_year"></span>
            <span x-text="zip_dialog_month"></span>
            <span x-text="zip_dialog_date"></span>
          </div>
        </div>

        <div class="pb-2">
          <template x-for="value in Array.from(emails)">
            <div class="flex flex-row justify-between apt-emails-form p-2">
              <input type="text" name="emails" hidden="hidden" x-bind:value="value">
              <div class="flex align-middle" x-text="value"></div>
              <button type="button" @click.prevent="emails.delete(value)"><img class="h-6 w-6" src="/assets/trash.svg"
                                                                               alt="delete-email"></button>
            </div>
          </template>

        </div>

        <div id="emails-zip" class="">

        </div>

        <div class="flex flex-row gap-4">
          <input id="email-zip-input" class="input input-bordered w-full" placeholder="Email"
                 type="email"
                 x-model="email_input"
                 @keyup.enter="$dispatch('add-receipt-zip-dialog-email', { email: $el?.value?.trim() })"
                 autocomplete="email">
          <button type="button"
                  class="btn btn-primary"
                  @click.prevent="$dispatch('add-receipt-zip-dialog-email', { email: $el.previousElementSibling?.value?.trim() })">
            Añadir
          </button>
        </div>

        <div id="zip-dialog-error">
        </div>

        <div class="flex flex-row gap-4">
          <button type="submit" class="btn btn-primary"
                  x-effect="$el.disabled=emails.size === 0">
            Enviar
          </button>
          <button type="button" class="btn btn-secondary"
                  @click="zip_dialog_open = false">
            Cancelar
          </button>
          <img class="htmx-indicator white-filter" src="/assets/bars.svg" alt="spinner">
        </div>

      </div>
    </form>

  </dialog>
</div>


</body>
</html>