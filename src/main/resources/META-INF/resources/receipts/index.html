<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Recibos</title>
  <link href="/out/css/output.css" rel="stylesheet"/>
  <script src="/out/js/index.js" defer></script>
</head>
<body>


<div class="bg-base-100 flex flex-col gap-1 p-1" id="header-container" hx-swap-oob="true">
  <div id="progress-receipts" class="text-center">
  </div>
  <div class="header">
    <div id="receipts-counters"></div>
    <label>
      <div id="buildings-selector"></div>
    </label>

    <div id="receipts-updater"
         hidden="hidden"
         hx-get="/api/receipts"
         hx-include="[name='building_input'],[name='month_input'],[name='date_input']"
         hx-trigger="update_receipts delay:400ms"
         hx-target="#receipt-grid"
         hx-swap="innerHTML"
         hx-indicator=".htmx-indicator"
    >

    </div>

    <input class="datepicker"
           type="date"
           name="date_input"
           placeholder="YYYY-MM-DD"
           script="on change send 'update_receipts' to #receipts-updater">

    <div>

      <select name="month_input"
              script="on change send 'update_receipts' to #receipts-updater"
              data-te-select-init
              multiple>

        <option value="1">Enero</option>
        <option value="2">Febrero</option>
        <option value="3">Marzo</option>
        <option value="4">Abril</option>
        <option value="5">Mayo</option>
        <option value="6">Junio</option>
        <option value="7">Julio</option>
        <option value="8">Agosto</option>
        <option value="9">Septiembre</option>
        <option value="10">Octubre</option>
        <option value="11">Noviembre</option>
        <option value="12">Diciembre</option>
      </select>
      <label data-te-select-label-ref>Mes</label>
    </div>

    <input id="file-input" hidden="hidden"/>

    <img class="htmx-indicator white-filter" src="/assets/bars.svg" alt="spinner">
  </div>
</div>

<div id="container" hx-swap-oob="true" class="p-2 gap-1 flex flex-col"
     x-data="{zip_dialog_receipt_key: '', zip_dialog_csrf_token_name: '', zip_dialog_csrf_token: '', zip_dialog_building: '', zip_dialog_date: '', zip_dialog_year: 0, zip_dialog_month: ''}">

  <script>
    initReceipt();
    window.Alpine.effect(() => {
      if (zipDialogData.zip_dialog_open) {
        emailZipDialogBtnSubmit.disabled = true;
        document.getElementById("dialog-cm-zip").show();
      } else {
        document.getElementById("dialog-cm-zip").close();
        dataEmailZip.emails = [];
      }
    });
  </script>

  <div id="receipt-grid">
    <div hx-get="/api/receipts/init" hx-indicator=".htmx-indicator" hx-trigger="load" hx-swap="outerHTML"></div>
  </div>

  <div>
    <img class="htmx-indicator center img-medium-size white-filter" src="/assets/bars.svg" alt="spinner">
  </div>

  <dialog id="dialog-cm" hidden="hidden">

  </dialog>

  <dialog id="dialog-cm-zip"
          class="z-30 form-container rounded border-2 border-gray-400 bg-base-100 m-0 top-1/2 left-1/2 p-2 max-h-95per min-w-1/2"
  >

    <form id="send-zip-form"
          hx-post="/api/receipts/send_zip"
          hx-swap="none"
          hx-indicator=".htmx-indicator">

      <script>
        document.getElementById("send-zip-form").addEventListener("keypress", (event) => {
          event.key === "Enter" && event.preventDefault();
        });

      </script>

      <div id="receipt-dialog-content-zip" class="p-2 h-full text-center align-middle flex flex-col gap-4">

        <input type="hidden" type="text" name="key" x-bind:value="zip_dialog_receipt_key">

        <input type="hidden" type="text" x-bind:name="zip_dialog_csrf_token_name" x-bind:value="zip_dialog_csrf_token"/>

        <div class="flex flex-row justify-between">
          <div style="height: 3rem; width: 3rem;">

          </div>
          <h2 class="font-bold m-auto">ENVIAR ZIP</h2>
          <div>
            <button type="button" class="btn btn-square btn-outline btn-error" style="height: 3rem; width: 3rem;"
                    @click="zipDialogData.zip_dialog_open = false"
            >
              <img src="/assets/cross-svgrepo-com.svg" alt="remove-email" style="height: 1.5rem; width: 1.5rem">
            </button>
          </div>
        </div>

        <div class="flex flex-col gap-2 font-bold pb-2">
          <div>
            <span x-text="zip_dialog_building"></span>
          </div>

          <div class="flex flex-row gap-2 justify-center">
            <span x-text="zip_dialog_year"></span>
            <span x-text="zip_dialog_month"></span>
            <span x-text="zip_dialog_date"></span>
          </div>
        </div>

        <script id="email-zip-template" type="text/x-handlebars-template">
          <div class="flex flex-row justify-between receipt-email-zip p-2">
            <input type="text" name="emails" hidden="hidden" value="{{value}}">
            <div class="flex align-middle">{{value}}</div>
            <button type="button" @click.prevent="removeEmail('{{value}}')"><img src="/assets/trash.svg"
                                                                                 alt="delete-email"></button>
          </div>
        </script>

        <div id="emails-zip" class="">

        </div>

        <div class="flex flex-row gap-4">
          <input id="email-zip-input" class="input input-bordered w-full" placeholder="Email"
                 type="email"
                 script="on keyup[key is 'Enter'] call addEmail('email-zip-input')"
                 autocomplete="email">
          <button type="button"
                  class="btn btn-primary"
                  script="on click call addEmail('email-zip-input')">
            AÃ±adir
          </button>
        </div>

        <div class="flex flex-row gap-4">
          <button id="submit-receipt-zip" type="submit" class="btn btn-primary" disabled>
            Enviar
          </button>
          <button type="button" class="btn btn-secondary"
                  @click="zipDialogData.zip_dialog_open = false">
            Cancelar
          </button>
          <img class="htmx-indicator white-filter" src="/assets/bars.svg" alt="spinner">
        </div>

        <script>

          function addEmail(inputId) {
            console.debug("addEmail", inputId);
            let input = document.getElementById(inputId);
            let email = input.value?.trim();
            if (validateEmail(email)) {
              if (dataEmailZip.emails.includes(email)) {
                console.debug("email already added", email, inputId);
                return;
              }

              console.debug("email added", email, inputId);
              dataEmailZip.emails.push(email);
              document.getElementById(inputId).value = "";
              return;
            }
            console.debug("invalid email", email, inputId, dataEmailZip.emails);
          }

          function removeEmail(email) {
            console.debug("removeEmail", email);
            dataEmailZip.emails = dataEmailZip.emails.filter((e) => e !== email);
          }

          window.Alpine.effect(() => {
            let emails = dataEmailZip.emails;

            if (emails.length > 0) {
              console.debug("enable btn");
              emailZipDialogBtnSubmit.disabled = false;
            } else {
              console.debug("disable btn");
              emailZipDialogBtnSubmit.disabled = true;
            }
            let template = emailZipTemplate.innerHTML;
            emailsZip.innerHTML = "";

            emails.forEach((email) => {
              let templateScript = window.Handlebars.compile(template);
              let html = templateScript({value: email});
              emailsZip.innerHTML += html;
            });

          });

        </script>
      </div>
    </form>

  </dialog>
</div>


</body>
</html>