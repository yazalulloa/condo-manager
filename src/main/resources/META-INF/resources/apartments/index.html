<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Apartamentos</title>
  <link href="/out/css/output.css" rel="stylesheet"/>
  <script src="/out/js/index.js" defer></script>
</head>
<body>

<div class="bg-base-100" id="header-container" hx-swap-oob="true">

  <div class="header">

    <div id="apartment-counters-container"
         hx-get="/api/apartments/counters"
         hx-vals="js:{building: document.querySelector('#buildings-selector select').value, q: document.querySelector('#apt-search-input').value}"
         hx-target="#apartment-counters"
         hx-indicator=".htmx-indicator"
         hx-trigger="get_counters">
      <div id="apartment-counters">
      </div>
    </div>

    <label>
      <div id="buildings-selector"></div>
    </label>

    <label for="apt-search-input"></label>
    <input class="input input-bordered w-full max-w-xs" id="apt-search-input" type="search" name="q"
           hx-get="/api/apartments/grid"
           hx-include="[name='building']"
           hx-trigger="keyup changed delay:300ms, search, new_apt"
           hx-target="#apartment-rows"
           hx-swap="innerHTML"
           hx-indicator=".htmx-indicator"
           placeholder="Buscar..."
    >

    <!--    on click set #apt-form-aliquot@value to '0'-->
    <button script="
    on click if #hidden-apt-building-id != null remove #hidden-apt-building-id end
    on click remove @disabled from <select/> in #apartment-form
    on click remove @disabled from <input/> in #apartment-form

    on click put 'Crear' into #apt-form-btn-submit
    on click if #apartment-form-general-error != null remove #apartment-form-general-error end
    on click remove .hidden from #apt-form-container
    on click send 'dispose-validation' to #apartment-form
    on click send clear to <cm-form-input/> in #apt-form-inputs
"
            class="btn btn-primary">
      Nuevo
    </button>

    <img class="htmx-indicator white-filter" src="/assets/bars.svg" alt="spinner">
  </div>

  <div class="apartment-grid-header p-2 font-bold">
    <span>Edificio</span>
    <span>Apto</span>
    <span>Nombre</span>
    <span>Emails</span>
    <span>Alícuota</span>
    <span>Acciones</span>
  </div>
</div>


<div id="container" hx-swap-oob="true" class="overflow-auto">
  <div id="apartment-rows" hx-get="/api/apartments/init" hx-indicator=".htmx-indicator"
       hx-trigger="load"
       hx-swap="innerHTML">
  </div>

  <div>
    <img class="htmx-indicator white-filter img-medium-size center" src="/assets/bars.svg" alt="spinner">
  </div>

  <div id="apt-form-container"
       class="hidden form-container border-2 border-gray-400 bg-base-100 max-h-90per max-w-3/4 min-w-[310px] w-1/2 overflow-auto rounded-md z-30">
    <div class="header apt-form-title">
      <span class="font-bold">Nuevo Apartamento</span>
      <img class="htmx-indicator white-filter" src="/assets/bars.svg" alt="spinner">
      <button class="btn btn-square btn-outline btn-error" type="button"
              script="on click add .hidden to #apt-form-container"
      >
        <img src="/assets/cross-svgrepo-com.svg" alt="close-form">
      </button>
    </div>

    <form id="apartment-form"></form>
  </div>

  <dialog id="apt-form-dialog"
          open
          x-data="{emails: new Set()}"
          @add-apt-form-email="
          let v = $event.detail?.email?.trim();
          if (v && v.length > 0 && validateEmail(v)) {
            emails.add(v);
          }
          "
          class="z-30 form-container rounded border-2 border-gray-400 bg-base-100 m-0 top-1/2 left-1/2 max-h-95per max-w-9/10 min-w-1/2">

    <div x-data="{dialog_open: true}" x-effect=" if (dialog_open) {
            document.getElementById('apt-form-dialog').show();
          } else {
            document.getElementById('apt-form-dialog').close();
            emails.clear();
          }">

      <form class="pb-2 px-3 flex flex-col"
            hx-post="/api/apartments/v2"
            hx-swap="none"
            hx-indicator=".htmx-indicator"
            x-data="{ number: '', name: '', aliquot: 0}">

        <div id="apt-csrf-input" hidden="hidden"></div>

        <script>
          document.currentScript.parentElement.addEventListener("keypress", (event) => {
            event.key === "Enter" && event.preventDefault();
          });


        </script>

        <div class="h-full text-center align-middle flex flex-col gap-4">

          <div class="flex flex-row justify-between">
            <div style="height: 3rem; width: 3rem;">

            </div>
            <h2 class="font-bold m-auto">Nuevo Apartamento</h2>
            <div>
              <button type="button" class="btn btn-square btn-outline btn-error" style="height: 3rem; width: 3rem;"
                      @click="dialog_open = false"
              >
                <img src="/assets/cross-svgrepo-com.svg" alt="remove-email" style="height: 1.5rem; width: 1.5rem">
              </button>
            </div>
          </div>
        </div>

        <label class="form-control w-full">
          <div class="label">
            <span class="label-text">Edificio</span>
          </div>
          <select name="buildingId"
                  class="select select-bordered w-full">
            <option hx-get="/api/buildings/selector" hx-indicator=".htmx-indicator" hx-trigger="load"
                    hx-swap="outerHTML">
            </option>
          </select>
          <div class="label">
            <span class="label-text-alt error-message" hidden="hidden">Alt label</span>
            <span class="label-text-alt" hidden="hidden">Alt label</span>
          </div>
        </label>

        <label class="form-control w-full">
          <div class="label">
            <span class="label-text">Nro. Apt</span>
          </div>
          <input type="text" placeholder="Nro. Apt" class="input input-bordered w-full" name="number"
                 x-model="number"/>
          <div class="label">
            <span class="label-text-alt error-message" hidden="hidden">Bottom Left label</span>
          </div>
        </label>

        <label class="form-control w-full">
          <div class="label">
            <span class="label-text">Nombre</span>
          </div>
          <input type="text" placeholder="Nombre" class="input input-bordered w-full" name="name"
                 x-model="name"/>
          <div class="label">
            <span class="label-text-alt error-message" hidden="hidden">Bottom Left label</span>
          </div>
        </label>

        <label class="form-control w-full">
          <div class="label">
            <span class="label-text">Alícuota</span>
          </div>
          <input type="number" placeholder="Alícuota" class="input input-bordered w-full" name="aliquot" min="0"
                 step=".01" maxlength="5" max="100" x-model="aliquot"/>
          <div class="label">
            <span class="label-text-alt error-message" hidden="hidden">Bottom Left label</span>
          </div>
        </label>

        <script id="email-apt-form-template" type="text/x-handlebars-template">
          <div class="flex flex-row justify-between apt-emails-form p-2">
            <input type="text" name="emails" hidden="hidden" value="{{value}}">
            <div class="flex align-middle">{{value}}</div>
            <button type="button" @click.prevent="removeAptFormEmail('{{value}}')"><img src="/assets/trash.svg"
                                                                                        alt="delete-email"></button>
          </div>
        </script>

        <div>
          <template x-for="value in Array.from(emails)">
            <div class="flex flex-row justify-between apt-emails-form p-2">
              <input type="text" name="emails" hidden="hidden" :value="value">
              <div class="flex align-middle" x-text="value"></div>
              <button type="button" @click.prevent="emails.delete(value)"><img src="/assets/trash.svg"
                                                                            alt="delete-email"></button>
            </div>
          </template>

        </div>

        <div class="flex flex-row gap-4 pb-4">
          <input class="input input-bordered w-full" placeholder="Email"
                 type="email"
                 @keyup.enter="$dispatch('add-apt-form-email', { email: $el?.value?.trim() })"
                 autocomplete="email">
          <button type="button"
                  class="btn btn-primary"
                  @click.prevent="$dispatch('add-apt-form-email', { email: $el.previousElementSibling?.value?.trim() })">
            Añadir
          </button>
        </div>

        <div class="flex flex-row gap-4">
          <button type="submit" class="btn btn-primary"
                  x-effect="$el.disabled=!(number?.trim()?.length > 0 && name?.trim()?.length > 0 && aliquot && aliquot > 0 )">
            Crear
          </button>

          <button type="button" class="btn btn-secondary"
                  @click="dialog_open = false">
            Cancelar
          </button>
          <img class="htmx-indicator white-filter" src="/assets/bars.svg" alt="spinner">
        </div>

      </form>
    </div>


  </dialog>
</div>

</body>
</html>